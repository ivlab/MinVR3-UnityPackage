# Generating a Documentation Website

This project is configured to make it easy to generate a static website that can be viewed locally or hosted on services, like github pages, and that includes both manual pages and API documentation generated by analyzing the C# sourcecode.

The approach uses [DocFx](https://dotnet.github.io/docfx/index.html), a tool for auto-generating web-based documentation for C# projects by analyzing the C# source, including xml comments.  DocFx is challenging to configure but quite powerful and lovely to use once it is correctly configured.  Thankfully, this repository should already be configured to work well for IV/LAB projects that are hosted on either our public https://github.com/ivlab or internal https://github.umn.edu/ivlab-cs github sites.


## Prereqs: Installing DocFx

Step 1 is to install a recent stable release of DocFx by following [the instructions on their "getting started" page](https://dotnet.github.io/docfx/tutorial/docfx_getting_started.html).  The instructions differ a bit depending upon your platform.  

*Tip: As of summer 2022, the Apple M1 chipset is not yet supported, so M1 users be careful to follow the instructions to install with Rosetta support.*


## Website Structure

The website will consist of four key parts.  
1. The landing page.
2. The manual.
3. The API documentation.
4. API documentation "overrides".

The API documentation is auto-generated from your C# files.  The content for all of the other parts is written manually.  This is made as easy as possible by writing markdown instead of raw html.  


## DocFx Markdown Basics

Markdown is an easy-to-remember syntax ([link to a github markdown cheatsheet](https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet)) that gets converted into great looking html.  Markdown supports bullet lists, links, images, code snippets, and more.  All of github-flavor markdown is supported, and DocFx-flavor markdown even includes a few additions, [like support for embedded youtube videos](https://dotnet.github.io/docfx/spec/docfx_flavored_markdown.html#video).  

Any images or other non-textual resources you wish to use on the page should be added to the [DocumentationSrc~/resources](DocumentationSrc~/resources) folder.  Then, reference them in your markdown using a relative path from the location of your markdown file to the resources folder.

You can also add to other portions of the documentation.  To link to a manual page, add a markdown link with a relative path to the relevant .md file.  To link to a page in the API documentation, use [DocFx's Cross-Reference feature](https://dotnet.github.io/docfx/tutorial/links_and_cross_references.html#using-cross-reference).  In brief, the shorthand from to link to the documentation for a class is to write the "at" symbol followed by the namespace (if any) and the classname (e.g., \@IVLab.MinVR3.VREvent).


## Creating Each Section of the Website

### The Landing Page

Edit the [DocumentationSrc~/index.md](DocumentationSrc~/index.md) file to create the content for your landing page.  This is a great place to start to learn markdown if you are new to it.  Try including an image, linking to other pages, or creating an itemized list or table.

*Tip: The source for building the website is in the DocumentationSrc~ directory, and the website gets built into the Documentation~ directory.  The unusual tildas (~) at the end of the names is a Unity thing.  By convention, Unity places documentation for each package in a directory named Documentation~.  Also by convention, the Unity Editor ignores all directories with names that end with a tilda, so the documentation folder does not show up inside the editor and Unity does not create all those annoying .meta files for each file in the folder.  We adopt the same strategy for the documentation source, since it is built outside the Unity editor.  Be careful when working with these funky directory names in the unix shell.  You need to escape the tilda character by writing `\~` instead of `~`.  So, to change directories into the Documentation~ folder, you would type `cd Documentation\~` or use the tab auto-complete feature available in most shells, and let it do this for you!*

### The Manual

The contents of the manual portion of the docs are placed in the [DocumentationSrc~/manual](DocumentationSrc~/manual) folder.  If you're starting a new project, you will see a few placeholders there already.  You can add as many .md files as you wish here.  Each will produce one .html file.  There is also a special [table of contents file](DocumentationSrc~/manual/toc.yml).  Follow the examples that are already in the file to include any new pages you create in the table of contents.  

### The API Documentation

DocFx will generate almost all of this part of the website for you by analyzing your C# source files.  The one exception is the main page you reach when first clicking on API Documentation in the navigation bar at the top of the website.  This page is generated from [DocumentationSrc~/api/index.md](DocumentationSrc~/api/index.md).  The recommended use for this page is to create a list or chart of the main classes in your project organized by theme or functionality.  This is typically far more helpful to programmers than the table of contents on the left of the page, which simply provides an alphabetical list of all of the classes that appear in each namespace.  

To give DocFx the info it needs to create *useful* documentation for each of the key classes in your code, you need to document your code using the [documentation comments syntax built into the C# language specification](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/language-specification/documentation-comments).  The syntax is thorough but you can honestly accomplish quite a lot by simply remembering to include a summary tag right before you define a class or method, like this simple example from the Microsoft docs:
```
/// <summary>
/// Class Point models a point in a two-dimensional plane.
/// </summary>
public class Point
{
    /// <summary>
    /// Method Draw renders the point.
    /// </summary>
    void Draw() {...}
}
```

You can include or exclude portions of the API from the generated documentation by editing [DocumentationSrc~\filterConfig.yml](DocumentationSrc~\filterConfig.yml).

### The API Documentation "Overrides"

DocFx includes some cool features for github-hosted projects, specifically it will add two special links on the right hand side of each page it generates, one for "Improve this Doc" and one for "View Source".  These links take readers directly to a relevant page on github where they can edit or add to the source or documentation.  

The "Improve this Doc" link uses what DocFx calls an overwrite file.  This is a markdown file but with a bit of special meta data at the top to tell DocFx what the contents refer to.  If you click the "Improve this Doc" link while viewing a namespace or class, DocFx will send you to the git repo and start the process of creating an override document that allows you to add extra information into the docs for the particular class or namespace you are viewing.  This is an override in the sense that you are not modifying the actual C# source file, you are adding documentation that gets associated with and replaces some pieces of the documentation generated from the C# source file.  This provides one quick way to edit the documentation.  Of course, the other is to go right to the source, which you can do with the "View Source" link.

One downside of this approach is that the documentation for a piece of the API, like a class or method, can end up living in two places: documentation comments with the source itself and an override file. However, the upsides are: 1. It works really well for manual pages. 2. It works really well for documenting namespaces, where there is not really a single place in the code one would go to add documentation.  3. For sourcecode, the View Source link is really fantastic.  It takes you right to the correct line in the file, and if you wish to edit the file and then commit a change, you can just do this via the normal github web interface.

All of the overrides go in the [DocumentationSrc~/apidocs-overrides](DocumentationSrc~/apidocs-overrides) folder.  They are also written in markdown, but there is a special meta data section at the top.  Follow the examples in the directory to reproduce this section or just use the "Improve this Doc" link to have DocFx create this part for you and send you to github to fill in the rest of the file.

### DocFx Configuration

To make the API Documentation Overrides work, DocFx needs to know the git repo for the project.  You can configure this along with the name of your project and other settings in [DocumentationSrc~/projectMetadata.json](DocumentationSrc~/projectMetadata.json).

The `_appTitle` setting is self-explanatory.  The git related settings are a bit more nuanced:

```
  "_gitUrlPattern": "github.umn.edu",
```
Set to "github.umn.edu" if your project is hosted there or simply "github" (without the .com) if your project is in a public repo on github.com.  Note, we have had to create our own custom template (in the templates folder) to support github.umn.edu.  You will see "github" mentioned in the DocFx documentation, but not "github.umn.edu" or other variants.

```
  "_gitContribute": {
    "repo": "git@github.umn.edu/ivlab-cs/MinVR3-UnityPackage",
    "branch": "main",
    "apiSpecFolder": "Documentation~/apidocs-overrides",
  }
```
In the _gitContribute section, set the repo using either the ssh form or the https form.  Set the branch to the name of the branch where you would like any contributions made via the "Improve this Doc" link to be committed.  *Leave the apiSpecFolder setting as is.*

```
  "newFileRepository": {
    "branch": "main",
  },
```
A "new file" is created when users click on the "Improve this Doc" link but there is no clear choice for a file to modify.  In this case, DocFx decides the best action is to have the user add a completely new file to the repo where they document to their heart's content.  It's not clear how useful this is because if that file is not associated with any other part of the documentation or included in a table of contents, then users will not know how to reach it.  Nevertheless, this setting is for the branch to use when these new files are created.


## Actually Running DocFx to Generate the Documentation!

Configuring DocFx to actually support all of the git features described above, especially the critically important View Source link, turns out to be quite difficult.  After much trial and error, we have wrapped all the steps that need to be done into an easy-to-use shell script named [build-docs](DocumentationSrc~/build-docs).

1. Make sure you already have docfx installed, if not, go back to the top of this document to find the link to download it.
2. Open your usual unix-style shell (use Terminal on OSX, use Git Bash or similar on Windows).
3. Check to make sure that the docfx executable is in your PATH by running ```which docfx```.  If it prints a path to docfx, then proceed.  If not, figure out which directory you installed docfx in and add it to your path OR open up the [build-docs](DocumentationSrc~/build-docs) script and edit it to hardcode a path in the docfxExe variable.  
4. Build the docs by running the script.  You can call it from any directory, or you could cd into the `DocumentationSrc~` directory first, like this:
```
cd DocumentationSrc\~
./build-docs
```
5. View the results!  DocFx automatically starts up a webserver so you can preview the results.  Just open a browser and load up http://localhost:8080 to see the website.  Kill the server with Ctrl-C when you're done.

Note:  Run `build-docs --help` to see other options including build without starting the server and deleting all the intermediate build files docfx generates.


## Deploying on GitHub Pages

You can deploy your website to be viewed over the internet at pages.github.com or pages.github.umn.edu with just a few more steps.

1. Use `git add` to add all of the files for the newly built website to your next commit.  If it is the first time you are doing this, then the command `git add Documentation\~` should do the job.  Then run `git commit -m "updated documentation"` to commit those changes.  
2. Tell git to push the contents of the `Documentation~` folder to a branch called `gh-pages` on the remote origin for your repo.  You can do this with the command `git subtree push --prefix Documentation\~ origin gh-pages` but that is pretty hard to remember, so you can accomplish the same thing by running `build-docs --publish` if you prefer.

Summary:
```
cd root/of/your/repo
git add Documentation\~
git commit -m "updated documentation"
Documentation\~/build-docs --publish
```

3. If it is the first time you have done this, then you also need to tell github that you would like to use github pages for this repo.  
  - Go to the page for your repo on github.com or github.umn.edu.
  - Click *Settings* (Top Right) then select *Pages* (Bottom Left)
  - Under *Source* click on the dropdown labeled "None", select the "gh-pages" branch, and click *Save*.


To update the gh-pages version of the documentation in the future, you'll need to repeat steps 1-2.  

If your site is hosted on github.com you can make step 2 happen automatically whenever you push an update that changes the contents of the Documentation~ folder by using github actions.  [This gist explains how to do it.](https://gist.github.com/cobyism/4730490)  Unfortunately, github.umn.edu admins have disabled github actions for security reasons.


## Cheatsheet for Documentation Directory Structure

Key Files and Directories:
```
Runtime/Scripts --> root for .cs files that are the source for the API
Documentation~ --> DocFx destination dir; holds the complete built website.
DocumentationSrc~ --> DocFx and Markdown source for building the website.
   index.md --> Markdown content for the landing page (you edit)
   manual/ --> Markdown content for the manual section (you add/edit)
   resources/ --> Images / other content (you add/edit)
   apidocs-overrides/ --> Content contributed with the "Improve this Doc" link
   api/index.md --> API landing page (you edit)
   api/* --> Everything other than index.md is generated by DocFx
   projectMetadata.json --> project-specific settings (you edit)
   filterConfig.json --> docfx config (you might need to edit)
   build-docs --> build script (you should not need to edit)
   docfx.json --> docfx config (you should not need to edit)
   templates/ --> docfx templates with support for github.umn.edu (no edit)
   toc.yml --> Defines the structure of the navbar for documentation website
```
