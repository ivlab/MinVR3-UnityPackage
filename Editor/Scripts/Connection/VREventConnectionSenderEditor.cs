using System.Reflection;
using System.Collections.Generic;
using UnityEditor;
using UnityEngine;
using System.Linq;

namespace IVLab.MinVR3
{
    [CustomEditor(typeof(VREventConnectionSender))]
    public class VREventConnectionSenderEditor : Editor
    {
        public void OnEnable()
        {
            m_VREventFilteringStrategyProp = serializedObject.FindProperty("m_VREventFilteringStrategy");
            m_SendListPrototypesProp = serializedObject.FindProperty("m_SendListPrototypes");
            m_NoSendListPrototypesProp = serializedObject.FindProperty("m_NoSendListPrototypes");
            m_SendListStartsWithStringsProp = serializedObject.FindProperty("m_SendListStartsWithStrings");
            m_NoSendListStartsWithStringsProp = serializedObject.FindProperty("m_NoSendListStartsWithStrings");
        }

        public override void OnInspectorGUI()
        {
            serializedObject.Update();
            VREventConnectionSender script = (VREventConnectionSender) target;

            // Check to see if the GameObject has the proper script attached
            IVREventConnection conn;
            if (!script.TryGetComponent<IVREventConnection>(out conn))
            {
                var assembly = Assembly.GetAssembly(typeof(IVREventConnection));
                var vrEventConnectionTypes = assembly
                    .GetTypes()
                    .Where(t => t != typeof(IVREventConnection))
                    .Where(t => typeof(IVREventConnection).IsAssignableFrom(t))
                    .Select(t => t.Name);
                var typeListStr = "\n  - " + string.Join("\n  - ", vrEventConnectionTypes);

                EditorGUILayout.HelpBox("Error: the VREventConnectionSender must have an IVREventConnection " +
                    "attached to the same object. Please attach one of the following scripts:\n" + typeListStr,
                    MessageType.Error);
                return;
            }

            EditorGUILayout.LabelField("Filtering Strategy", EditorStyles.boldLabel);

            EditorGUILayout.HelpBox(new GUIContent("For convenience, there are several different ways you can specify the VREvents to send over the connection.  1: Send everything, 2: Send only the events that match the criteria you specify, 3: Send all events *except* those that match the criteria you specify."));

            EditorGUILayout.PropertyField(m_VREventFilteringStrategyProp);

            

            if (m_VREventFilteringStrategyProp.enumValueIndex == 0) {

                // nothing
                
            } else if (m_VREventFilteringStrategyProp.enumValueIndex == 1) {
                
                EditorGUILayout.Space();
                EditorGUILayout.HelpBox(new GUIContent("The event-matching criteria can be specified in two " +
                    "ways using the two lists below.  The first list uses VREventPrototypes and this is good for " +
                    "specifying a small set of specific events to send.  The second list is used for string matching " +
                    "on the event name.  Any events that START WITH any of the strings in this list are sent.  This " +
                    "is good for sending all events that begin with some prefix (e.g., all generated by a specific device)."));

                m_ShowFoldoutSend = EditorGUILayout.BeginFoldoutHeaderGroup(m_ShowFoldoutSend, "Send List VREvent Prototypes");

                if (m_ShowFoldoutSend) {
                    List<int> idxToDelete = new List<int>();

                    for (int evtNum = 0; evtNum < m_SendListPrototypesProp.arraySize; evtNum++) {
                        // Event name and event payload type
                        EditorGUILayout.BeginHorizontal();

                        EditorGUILayout.PropertyField(m_SendListPrototypesProp.GetArrayElementAtIndex(evtNum));

                        if (GUILayout.Button("-", GUILayout.Width(EditorGUIUtility.singleLineHeight))) {
                            idxToDelete.Add(evtNum);
                        }

                        EditorGUILayout.EndHorizontal();
                    }

                    foreach (int idx in idxToDelete) {
                        script.sendListPrototypes.RemoveAt(idx);
                    }

                    if (GUILayout.Button("+")) {
                        if (script.sendListPrototypes == null) {
                            script.sendListPrototypes = new List<VREventPrototypeAny>();
                        }
                        script.sendListPrototypes.Add(VREventPrototypeAny.Create(""));
                    }
                }

                EditorGUILayout.EndFoldoutHeaderGroup();

                EditorGUILayout.PropertyField(m_SendListStartsWithStringsProp);

            } else if (m_VREventFilteringStrategyProp.enumValueIndex == 2) {

                EditorGUILayout.Space();
                EditorGUILayout.HelpBox(new GUIContent("The event-matching criteria can be specified in two " +
                    "ways using the two lists below.  The first list uses VREventPrototypes and this is good for " +
                    "specifying a small set of specific events to block.  The second list is used for string matching " +
                    "on the event name.  Any events that START WITH any of the strings in this list are blocked.  This " +
                    "is good for blocking all events that begin with some prefix (e.g., all generated by a specific device)."));

                m_ShowFoldoutNoSend = EditorGUILayout.BeginFoldoutHeaderGroup(m_ShowFoldoutNoSend, "No Send List VREvent Prototypes");

                if (m_ShowFoldoutNoSend) {
                    List<int> idxToDelete = new List<int>();

                    for (int evtNum = 0; evtNum < m_NoSendListPrototypesProp.arraySize; evtNum++) {
                        // Event name and event payload type
                        EditorGUILayout.BeginHorizontal();

                        EditorGUILayout.PropertyField(m_NoSendListPrototypesProp.GetArrayElementAtIndex(evtNum));

                        if (GUILayout.Button("-", GUILayout.Width(EditorGUIUtility.singleLineHeight))) {
                            idxToDelete.Add(evtNum);
                        }

                        EditorGUILayout.EndHorizontal();
                    }

                    foreach (int idx in idxToDelete) {
                        script.noSendListPrototypes.RemoveAt(idx);
                    }

                    if (GUILayout.Button("+")) {
                        script.noSendListPrototypes.Add(VREventPrototypeAny.Create(""));
                    }
                }
                EditorGUILayout.EndFoldoutHeaderGroup();

                EditorGUILayout.PropertyField(m_NoSendListStartsWithStringsProp);
            }

            serializedObject.ApplyModifiedProperties();
        }


        bool m_ShowFoldoutSend = true;
        bool m_ShowFoldoutNoSend = true;
        SerializedProperty m_SendListPrototypesProp;
        SerializedProperty m_SendListStartsWithStringsProp;
        SerializedProperty m_NoSendListPrototypesProp;
        SerializedProperty m_NoSendListStartsWithStringsProp;
        SerializedProperty m_VREventFilteringStrategyProp;

    }

}